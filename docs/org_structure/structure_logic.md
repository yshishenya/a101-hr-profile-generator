# Логика построения организационной структуры

## Обзор файла "Структура.xlsx"

### Основные характеристики:
- **Формат**: Excel файл (.xlsx)
- **Лист**: "выгрузка"
- **Всего записей**: 2,844 строки
- **Уникальных организационных единиц (номеров)**: 545
- **Столбцы**: 8 (Номер, Уровень 2-7, Должность)

## Структура данных

### Столбцы:
1. **Номер** - Уникальный идентификатор организационной единицы (например: 24001190)
2. **Уровень 2** - Верхний уровень иерархии (9 уникальных блоков)
3. **Уровень 3** - Второй уровень (36 уникальных единиц)
4. **Уровень 4** - Третий уровень (120 уникальных единиц)
5. **Уровень 5** - Четвертый уровень (283 уникальных единиц)
6. **Уровень 6** - Пятый уровень (435 уникальных единиц)
7. **Уровень 7** - Самый глубокий уровень (489 уникальных единиц)
8. **Должность** - Конкретная позиция сотрудника

## Принципы построения иерархии

### 1. Иерархическая структура
Организация имеет многоуровневую структуру от 1 до 6 уровней глубины:
- **Глубина 1**: Высшее руководство на уровне блоков
- **Глубина 2**: Департаменты и службы внутри блоков
- **Глубина 3**: Управления внутри департаментов
- **Глубина 4**: Отделы внутри управлений
- **Глубина 5**: Группы внутри отделов
- **Глубина 6**: Специализированные подгруппы

### 2. Логика заполнения уровней
- **Повторение значений**: Если на уровне N+1 нет более детализированного подразделения, значение повторяется из уровня N
- **Остановка иерархии**: Иерархия может останавливаться на любом уровне - незаполненные уровни остаются пустыми

### 3. Примеры иерархических путей:

#### Глубина 1:
```
Блок безопасности
└── Заместитель генерального директора по безопасности
```

#### Глубина 2:
```
Блок безопасности → Служба безопасности
└── Руководитель службы безопасности
└── Ведущий специалист
```

#### Глубина 3:
```
Блок безопасности → Служба безопасности → Управление комплексной безопасности
└── Руководитель управления
└── Главный специалист (x3)
└── Специалист (x3)
```

#### Глубина 6:
```
Блок бизнес-директора → Коммерческий департамент → Блок продаж жилой недвижимости → 
Управление дистанционного взаимодействия и продаж → Отдел дистанционных продаж → 
Группа онлайн продаж
└── Руководитель группы
└── Менеджер по продажам (x2)
```

## Ключевые закономерности

### 1. Номера и организационные единицы
- **Один номер = одна организационная единица**: Каждый номер привязан строго к одной единице в иерархии
- **Множественные должности**: В рамках одного номера может быть несколько разных должностей
- **Никаких пересечений**: Один номер никогда не относится к разным частям организации

### 2. Верхний уровень (Уровень 2) - 9 основных блоков:
1. Блок безопасности
2. Блок бизнес-директора
3. Блок директора по правовому обеспечению и управлению рисками
4. Блок директора по развитию
5. Блок исполнительного директора
6. Блок операционного директора
7. ГК А101
8. Дирекция "Социальные объекты"
9. Управление внутреннего аудита и контроля

### 3. Построение JSON структуры
Для сохранения иерархии в JSON необходимо:
- Извлечь реальную иерархическую цепочку (убрав повторы)
- Сгруппировать должности по номерам
- Построить древовидную структуру от корня к листьям
- Сохранить полный путь для каждой конечной должности

## Алгоритм преобразования

### Шаг 1: Извлечение иерархии
```python
def extract_hierarchy(row):
    levels = []
    prev_level = None
    for level_col in ['Уровень 2', 'Уровень 3', 'Уровень 4', 'Уровень 5', 'Уровень 6', 'Уровень 7']:
        current_level = row[level_col]
        if pd.isna(current_level):
            break
        if current_level != prev_level:
            levels.append(current_level)
            prev_level = current_level
    return levels
```

### Шаг 2: Группировка по номерам
- Собрать все должности для каждого номера
- Сохранить иерархический путь для каждой группы

### Шаг 3: Построение дерева
- Создать рекурсивную структуру от корня
- Для каждого узла добавить дочерние элементы
- В листьях разместить конкретные должности

### Шаг 4: Результирующая JSON структура
```json
{
  "organization": {
    "Блок безопасности": {
      "positions": ["Заместитель генерального директора по безопасности"],
      "children": {
        "Служба безопасности": {
          "positions": ["Руководитель службы безопасности", "Ведущий специалист"],
          "children": {
            "Управление комплексной безопасности": {
              "positions": ["Руководитель управления", "Главный специалист", "Специалист"],
              "number": "24001181"
            }
          }
        }
      }
    }
  }
}
```

## Выводы

1. **Структура четко иерархическая** - каждый уровень вложен в предыдущий
2. **Номера однозначно идентифицируют организационные единицы** - нет пересечений между разными частями структуры  
3. **Глубина иерархии варьируется** - от 1 до 6 уровней в зависимости от сложности подразделения
4. **Множественные должности в единице** - один номер может содержать несколько разных позиций
5. **Повторы в столбцах уровней** - используются для заполнения "пустых" уровней иерархии

Эта логика позволяет точно восстановить организационную структуру и построить корректный JSON с сохранением всех иерархических связей.
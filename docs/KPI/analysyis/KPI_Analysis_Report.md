# Анализ структуры KPI файлов и рекомендации по парсингу

## Исполнительное резюме

**РЕКОМЕНДАЦИЯ: Необходим LLM для качественного парсинга KPI файлов**

Средний показатель сложности: **69/100**  
Максимальный показатель сложности: **85/100**

## Детальный анализ проблем

### 1. Структурная сложность

#### Объединенные ячейки (28 всего)
- **КПЭ 2025_АС**: 21 объединенная область 
- **КПЭ 2025_ДИТ**: 4 объединенные области
- **КПЭ 2025_ТОП**: 1 объединенная область

Объединенные ячейки используются для:
- Группировки сотрудников по отделам
- Создания многоуровневых заголовков
- Визуального объединения связанных KPI

#### Многоуровневая структура заголовков
Все файлы содержат сложную иерархию заголовков:
- Строка 1: Названия отделов и подразделений
- Строка 2: Должности руководителей
- Строка 3: ФИО сотрудников
- Строка 4+: Категории KPI

### 2. Неоднородность данных

#### Различные типы KPI:
1. **Корпоративные KPI**: Общие для всех (NPV, продажи, дивиденды)
2. **Личные KPI**: Специфичные для каждого сотрудника
3. **Триггерные показатели**: Специальные условия выполнения

#### Разнообразие единиц измерения:
- Процентные значения (%, коэффициенты 0-1)
- Абсолютные значения (млн. руб., тыс. м2, шт.)
- Текстовые описания задач

### 3. Форматирование и семантика

#### Форматирование несет смысловую нагрузку:
- **Различные шрифты**: 3-7 разных стилей на файл
- **Цветовая кодировка**: 1-3 различных заливки
- **Формулы**: 63 формулы всего (автоподсчет количества KPI)

#### Семантические особенности:
- Переносы строк внутри ячеек с описаниями KPI
- Сложные текстовые описания методик расчета
- Вложенные списки задач в описаниях

## Примеры сложности структуры

### Пример 1: Многоуровневые заголовки
```
Строка 1: ["", "", "", "", "", "", "ПТО", "Отдел бюджетирования...", "САО Новая Москва"]
Строка 2: ["", "", "", "Руководитель управления...", "Заместитель руководителя..."]
Строка 3: ["КПЭ", "Целевое значение", "Ед. изм.", "Ларина Ольга Александровна", "Ким Александр..."]
```

### Пример 2: Сложные описания KPI
```
KPI: "Формирование бюджетов затрат по проектам точно в срок с надлежащим качеством:
      Ежеквартальное обновление бюджетов
      Формирование целевых бюджетов (после РС)
      Формирование бюджетов перспективных объектов"
```

### Пример 3: Объединенные ячейки для группировки
```
Объединение V5:V8 = "0.3" (вес KPI для группы сотрудников)
Объединение I1:O1 = "САО Новая Москва" (название подразделения)
```

## Технические ограничения простого парсера

### 1. Pandas ограничения:
- Не может корректно интерпретировать объединенные ячейки
- Теряет информацию о форматировании
- Неправильно определяет границы данных
- Размер через pandas: (26, 29) vs реальный (26, 102)

### 2. Openpyxl ограничения:
- Требует ручной логики для обработки merged cells
- Сложно автоматически определить структуру заголовков
- Необходима интерпретация семантики форматирования

## Рекомендуемое решение: LLM-парсер

### Преимущества LLM подхода:

#### 1. Интеллектуальная интерпретация структуры
- Понимание многоуровневых заголовков
- Автоматическое определение границ данных
- Интерпретация объединенных ячеек

#### 2. Семантическое понимание контента
- Классификация типов KPI
- Извлечение смысла из сложных текстовых описаний
- Понимание связей между сотрудниками и их KPI

#### 3. Обработка неоднородности
- Адаптация к различным форматам файлов
- Гибкое извлечение данных разной структуры
- Обработка исключений и нестандартных случаев

### Архитектура решения:

```
Excel File → LLM Vision/Text Model → Structured JSON
           ↓
    1. Визуальный анализ структуры
    2. Извлечение текстового содержимого  
    3. Идентификация паттернов и связей
    4. Генерация структурированного JSON
```

### Ожидаемый JSON результат:
```json
{
  "file_info": {
    "filename": "КПЭ 2025_АС (Ларина О)+.xlsx",
    "department": "Управление анализа себестоимости"
  },
  "employees": [
    {
      "name": "Ларина Ольга Александровна",
      "position": "Руководитель управления анализа себестоимости",
      "corporate_kpis": [
        {
          "name": "Продажи/выручка по всем бизнесам компании", 
          "target": 126041,
          "unit": "млн. руб.",
          "weight": 0.15
        }
      ],
      "personal_kpis": [...]
    }
  ]
}
```

## Альтернативные подходы (не рекомендуются)

### 1. Простой pandas парсер
❌ **Оценка сложности: 85/100 - слишком высоко**
- Потеря 60-70% структурной информации
- Невозможность корректной обработки merged cells
- Требует множественных исправлений вручную

### 2. Продвинутый parserр на openpyxl
⚠️ **Возможен, но очень трудозатратен**  
- Необходимо 50+ правил для обработки различных случаев
- Высокий риск ошибок при изменении структуры файлов
- Сложность поддержки и доработки

## Финальная рекомендация

**Использовать LLM (GPT-4 Vision или Claude) для парсинга KPI файлов**

### Обоснование:
1. **Высокая сложность структуры** (69/100 в среднем)
2. **Много объединенных ячеек** (28 областей)
3. **Семантически сложный контент** (многоуровневые описания)
4. **Неоднородность между файлами**
5. **Форматирование как носитель смысла**

### Преимущества подхода:
- **Качество**: 95%+ точность извлечения
- **Гибкость**: Адаптация к новым форматам
- **Поддержка**: Минимальные доработки при изменениях
- **Скорость**: Быстрая обработка после настройки

### Ожидаемые результаты:
- Полностью структурированные JSON данные
- Сохранение всех связей и иерархий
- Готовность к дальнейшей автоматизации
- Масштабируемость на новые файлы

---

*Анализ выполнен с использованием openpyxl и pandas*  
*Дата: 2025-09-07*
"""
Generic KPI templates for different department types.
Used when specific KPI file not available.

This module provides fallback KPI templates to ensure 100% coverage
across all 545+ departments in the organization.

Coverage before: 1.7% (9/545 departments)
Coverage after: 100% (545/545 departments)
"""

from typing import Dict

# Department type detection mapping
# Maps keywords in department names to standardized department types
DEPARTMENT_TYPE_MAPPING: Dict[str, str] = {
    # IT & Digital Departments
    "информационных технологий": "IT",
    "цифровизации": "IT",
    "цифра": "IT",
    "дит": "IT",
    "автоматизации": "IT",
    "данных": "IT",
    "аналитик": "IT",
    "digital": "IT",

    # Sales & Commercial
    "продаж": "SALES",
    "коммерческ": "SALES",
    "реализации": "SALES",

    # Marketing
    "маркетинг": "MARKETING",
    "рекламы": "MARKETING",
    "брендинг": "MARKETING",

    # Construction & Technical
    "строительства": "CONSTRUCTION",
    "строител": "CONSTRUCTION",
    "проектирования": "ENGINEERING",
    "проектн": "ENGINEERING",
    "архитектур": "ARCHITECTURE",
    "технического надзора": "CONSTRUCTION",

    # Support Functions
    "персонала": "HR",
    "прп": "HR",
    "hr": "HR",
    "управления персоналом": "HR",
    "финанс": "FINANCE",
    "бухгалтер": "FINANCE",
    "юридическ": "LEGAL",
    "правов": "LEGAL",
    "безопасности": "SECURITY",
    "охран": "SECURITY",

    # Procurement & Supply Chain
    "закупк": "PROCUREMENT",
    "снабжен": "PROCUREMENT",
    "логистик": "PROCUREMENT",

    # Quality & Control
    "контрол": "QUALITY",
    "качества": "QUALITY",
    "аудит": "QUALITY",

    # Development & Investment
    "развития": "DEVELOPMENT",
    "инвестиц": "DEVELOPMENT",
    "стратег": "STRATEGY",

    # Default fallback
    "default": "GENERIC"
}

# Generic KPI templates by department type
KPI_TEMPLATES: Dict[str, str] = {
    "IT": """---
department: IT (Generic Template)
description: Generic KPI template for IT departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для IT департаментов

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом
- Тип: На увеличение
- Источник: Финансовая отчетность

### Ввод в эксплуатацию ЖК (15%)
- Целевое значение: определяется годовым планом
- Единицы: тыс. м²
- Тип: На увеличение

### Стратегические инициативы (10%)
- Выполнение стратегического плана: ≥ 90%
- Источник: Отчеты по проектам

## Личные КПЭ департамента (60%)

### 1. Доступность IT систем (SLA) - 15%
- **Целевое значение**: ≥ 99.5%
- **Формула**: SLA = (Время доступности - Время недоступности) / Время доступности × 100%
- **Минимум**: 99.0% (80% выполнения)
- **Целевое**: 99.5% (100% выполнения)
- **Максимум**: 99.9% (120% выполнения)
- **Источник**: Система мониторинга, отчеты BI

### 2. Среднее время устранения инцидентов (MTTR) - 10%
- **Целевое значение**: ≤ 8 часов
- **Формула**: MTTR = Σ(Время решения инцидентов) / Количество инцидентов
- **Минимум**: ≤ 12 часов (80%)
- **Целевое**: ≤ 8 часов (100%)
- **Максимум**: ≤ 4 часов (120%)
- **Источник**: ServiceDesk, Jira

### 3. Удовлетворенность пользователей (NPS) - 10%
- **Целевое значение**: ≥ 4.5/5.0
- **Формула**: Средняя оценка по всем оцененным заявкам
- **Минимум**: 4.0 (80%)
- **Целевое**: 4.5 (100%)
- **Максимум**: 4.8 (120%)
- **Источник**: Опросы пользователей, система оценки заявок

### 4. Выполнение проектов в срок - 10%
- **Целевое значение**: ≥ 90%
- **Формула**: Количество проектов в срок / Общее количество проектов × 100%
- **Минимум**: 80% (80%)
- **Целевое**: 90% (100%)
- **Максимум**: 95% (120%)
- **Источник**: MS Project, Jira

### 5. Информационная безопасность - 10%
- **Целевое значение**: 0 критичных инцидентов
- **Метрики**:
  - Отсутствие утечек данных
  - Своевременное устранение уязвимостей (≤ 30 дней)
  - Соблюдение политик ИБ (100%)
- **Источник**: Отчеты ИБ, аудит

### 6. Оптимизация затрат - 5%
- **Целевое значение**: Выполнение бюджета ±5%
- **Формула**: |Факт - План| / План × 100%
- **Источник**: Финансовые отчеты
""",

    "SALES": """---
department: Sales (Generic Template)
description: Generic KPI template for sales departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов продаж

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (20%)
- Целевое значение: определяется годовым планом
- Тип: На увеличение
- Вклад: критичный для отдела продаж

### Ввод в эксплуатацию ЖК (10%)
- Целевое значение: определяется годовым планом
- Связь: обеспечение объектов для продаж

### Выплата дивидендов (10%)
- Целевое значение: определяется решением акционеров
- Связь: прибыльность продаж

## Личные КПЭ департамента (60%)

### 1. Выполнение плана продаж - 20%
- **Целевое значение**: 100% от плана
- **Формула**: Факт продаж / План продаж × 100%
- **Минимум**: 90% (80% выполнения KPI)
- **Целевое**: 100% (100% выполнения KPI)
- **Максимум**: 110% (120% выполнения KPI)
- **Источник**: CRM, 1С

### 2. Средний чек сделки - 10%
- **Целевое значение**: рост на 5% год к году
- **Формула**: Общая выручка / Количество сделок
- **Отслеживание**: динамика по месяцам
- **Источник**: CRM, аналитика продаж

### 3. Конверсия лидов в сделки - 10%
- **Целевое значение**: ≥ 20%
- **Формула**: Количество закрытых сделок / Количество лидов × 100%
- **Минимум**: 15% (80%)
- **Целевое**: 20% (100%)
- **Максимум**: 25% (120%)
- **Источник**: CRM

### 4. Скорость закрытия сделок (Time to Close) - 10%
- **Целевое значение**: ≤ 60 дней
- **Формула**: Средняя длительность сделки от первого контакта до подписания
- **Минимум**: ≤ 90 дней (80%)
- **Целевое**: ≤ 60 дней (100%)
- **Максимум**: ≤ 45 дней (120%)
- **Источник**: CRM

### 5. Индекс лояльности клиентов (NPS) - 5%
- **Целевое значение**: ≥ 40
- **Формула**: % промоутеров - % критиков
- **Минимум**: 30 (80%)
- **Целевое**: 40 (100%)
- **Максимум**: 50 (120%)
- **Источник**: Опросы клиентов

### 6. Качество ведения CRM - 5%
- **Целевое значение**: ≥ 95% полнота данных
- **Метрики**:
  - Своевременность обновления информации
  - Полнота заполнения карточек клиентов
  - Актуальность контактных данных
- **Источник**: Аудит CRM
""",

    "CONSTRUCTION": """---
department: Construction (Generic Template)
description: Generic KPI template for construction departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов строительства

## Корпоративные КПЭ (40%)

### Ввод в эксплуатацию ЖК (20%)
- Целевое значение: определяется годовым планом
- Единицы: тыс. м²
- Тип: На увеличение

### Продажи/Выручка (10%)
- Целевое значение: определяется годовым планом
- Связь: своевременная сдача объектов

### Стратегические инициативы (10%)
- Выполнение плана строительства: ≥ 95%

## Личные КПЭ департамента (60%)

### 1. Соблюдение сроков строительства - 20%
- **Целевое значение**: ≥ 90% объектов в срок
- **Формула**: Объекты сданные в срок / Общее количество объектов × 100%
- **Минимум**: 80% (80% выполнения)
- **Целевое**: 90% (100% выполнения)
- **Максимум**: 95% (120% выполнения)
- **Источник**: График строительства, MS Project

### 2. Соблюдение бюджета - 15%
- **Целевое значение**: отклонение ≤ 5%
- **Формула**: |Факт - План| / План × 100%
- **Минимум**: ≤ 10% (80%)
- **Целевое**: ≤ 5% (100%)
- **Максимум**: ≤ 3% (120%)
- **Источник**: Финансовые отчеты, 1С

### 3. Качество выполненных работ - 10%
- **Целевое значение**: ≥ 4.5/5.0
- **Метрики**:
  - Оценка технадзора
  - Количество дефектов при сдаче (≤ 10 на объект)
  - Отсутствие критичных замечаний
- **Минимум**: 4.0 (80%)
- **Целевое**: 4.5 (100%)
- **Максимум**: 4.8 (120%)
- **Источник**: Акты технадзора, протоколы приемки

### 4. Производительность труда - 5%
- **Целевое значение**: рост на 3% год к году
- **Формула**: м² / чел-день
- **Отслеживание**: динамика помесячно
- **Источник**: Отчеты по труду

### 5. Безопасность труда - 10%
- **Целевое значение**: 0 серьезных инцидентов
- **Метрики**:
  - Отсутствие травм с потерей трудоспособности
  - Проведение инструктажей (100%)
  - Соблюдение норм охраны труда
- **Источник**: Отчеты по охране труда, журналы инструктажей
""",

    "ENGINEERING": """---
department: Engineering (Generic Template)
description: Generic KPI template for engineering/design departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для проектных/инженерных департаментов

## Корпоративные КПЭ (40%)

### Ввод в эксплуатацию ЖК (15%)
- Целевое значение: определяется годовым планом
- Связь: своевременная подготовка проектной документации

### Стратегические инициативы (15%)
- Внедрение BIM технологий: прогресс по плану
- Оптимизация проектных решений: экономия 5%

### Продажи/Выручка (10%)
- Общий вклад в результаты компании

## Личные КПЭ департамента (60%)

### 1. Своевременность подготовки проектов - 20%
- **Целевое значение**: ≥ 95% проектов в срок
- **Формула**: Проекты сданные в срок / Общее количество × 100%
- **Минимум**: 85% (80%)
- **Целевое**: 95% (100%)
- **Максимум**: 98% (120%)
- **Источник**: MS Project, согласованные графики

### 2. Качество проектной документации - 15%
- **Целевое значение**: ≤ 5% замечаний при проверке
- **Формула**: Количество замечаний / Общее количество разделов × 100%
- **Минимум**: ≤ 10% (80%)
- **Целевое**: ≤ 5% (100%)
- **Максимум**: ≤ 2% (120%)
- **Источник**: Протоколы экспертизы, замечания заказчика

### 3. Соблюдение нормативных требований - 15%
- **Целевое значение**: 100% соответствие
- **Метрики**:
  - Отсутствие критичных нарушений СНиП/ГОСТ
  - Прохождение государственной экспертизы с первого раза
  - Соответствие актуальным нормативам
- **Источник**: Заключения экспертизы

### 4. Оптимизация проектных решений - 10%
- **Целевое значение**: экономия ≥ 3% от сметной стоимости
- **Формула**: (Исходная смета - Оптимизированная) / Исходная × 100%
- **Минимум**: 2% (80%)
- **Целевое**: 3% (100%)
- **Максимум**: 5% (120%)
- **Источник**: Сметная документация
""",

    "HR": """---
department: HR (Generic Template)
description: Generic KPI template for HR/personnel departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов управления персоналом

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом
- Связь: обеспечение компании персоналом

### Стратегические инициативы (15%)
- Выполнение HR стратегии: ≥ 90%
- Развитие корпоративной культуры

### Операционная эффективность (10%)
- Вклад HR в общую эффективность компании

## Личные КПЭ департамента (60%)

### 1. Закрытие вакансий - 15%
- **Целевое значение**: ≥ 85% вакансий в срок
- **Формула**: Закрытые вакансии в SLA / Общее количество × 100%
- **Минимум**: 75% (80%)
- **Целевое**: 85% (100%)
- **Максимум**: 90% (120%)
- **Источник**: ATS, отчеты рекрутинга

### 2. Текучесть персонала - 15%
- **Целевое значение**: ≤ 15% годовая
- **Формула**: Уволившиеся / Среднесписочная численность × 100%
- **Минимум**: ≤ 20% (80%)
- **Целевое**: ≤ 15% (100%)
- **Максимум**: ≤ 10% (120%)
- **Источник**: 1С ЗУП, HR отчеты

### 3. Вовлеченность сотрудников (eNPS) - 10%
- **Целевое значение**: ≥ 30
- **Формула**: % промоутеров - % критиков
- **Минимум**: 20 (80%)
- **Целевое**: 30 (100%)
- **Максимум**: 40 (120%)
- **Источник**: Опросы вовлеченности

### 4. Выполнение планов обучения - 10%
- **Целевое значение**: ≥ 90% плана
- **Формула**: Проведенные обучения / Запланированные × 100%
- **Минимум**: 80% (80%)
- **Целевое**: 90% (100%)
- **Максимум**: 95% (120%)
- **Источник**: LMS, отчеты по обучению

### 5. Качество адаптации новых сотрудников - 10%
- **Целевое значение**: ≥ 85% успешно прошли испытательный срок
- **Формула**: Прошли ИС / Принятые сотрудники × 100%
- **Минимум**: 75% (80%)
- **Целевое**: 85% (100%)
- **Максимум**: 90% (120%)
- **Источник**: 1С ЗУП, оценки руководителей
""",

    "FINANCE": """---
department: Finance (Generic Template)
description: Generic KPI template for finance/accounting departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для финансовых департаментов

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом
- Связь: точность финансового планирования

### Выплата дивидендов (15%)
- Целевое значение: определяется решением акционеров
- Связь: обеспечение финансовой стабильности

### Операционная эффективность (10%)
- Снижение операционных затрат: целевой процент

## Личные КПЭ департамента (60%)

### 1. Точность финансового планирования - 15%
- **Целевое значение**: отклонение ≤ 5%
- **Формула**: |Факт - План| / План × 100%
- **Минимум**: ≤ 10% (80%)
- **Целевое**: ≤ 5% (100%)
- **Максимум**: ≤ 3% (120%)
- **Источник**: Управленческая отчетность

### 2. Своевременность закрытия периода - 15%
- **Целевое значение**: на 3-й рабочий день месяца
- **Минимум**: 5-й день (80%)
- **Целевое**: 3-й день (100%)
- **Максимум**: 2-й день (120%)
- **Источник**: 1С, отчеты бухгалтерии

### 3. Отсутствие ошибок в отчетности - 15%
- **Целевое значение**: 0 критичных ошибок
- **Метрики**:
  - Отсутствие корректировок после сдачи
  - Прохождение аудита без замечаний
  - Соответствие МСФО/РСБУ
- **Источник**: Аудиторские отчеты

### 4. Управление дебиторской задолженностью - 10%
- **Целевое значение**: оборачиваемость ≤ 45 дней
- **Формула**: Средняя ДЗ × 365 / Выручка
- **Минимум**: ≤ 60 дней (80%)
- **Целевое**: ≤ 45 дней (100%)
- **Максимум**: ≤ 30 дней (120%)
- **Источник**: Управленческая отчетность

### 5. Оптимизация налоговой нагрузки - 5%
- **Целевое значение**: эффективная ставка ≤ целевой
- **Источник**: Налоговая отчетность, расчеты
""",

    "LEGAL": """---
department: Legal (Generic Template)
description: Generic KPI template for legal departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для юридических департаментов

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом
- Связь: юридическое сопровождение сделок

### Стратегические инициативы (15%)
- Минимизация правовых рисков
- Оптимизация договорной работы

### Операционная эффективность (10%)
- Снижение судебных издержек

## Личные КПЭ департамента (60%)

### 1. Скорость согласования документов - 15%
- **Целевое значение**: ≤ 3 рабочих дней
- **Формула**: Среднее время от получения до согласования
- **Минимум**: ≤ 5 дней (80%)
- **Целевое**: ≤ 3 дня (100%)
- **Максимум**: ≤ 2 дня (120%)
- **Источник**: Система согласования, SharePoint

### 2. Успешность судебных дел - 20%
- **Целевое значение**: ≥ 80% выигранных дел
- **Формула**: Выигранные дела / Общее количество × 100%
- **Минимум**: 70% (80%)
- **Целевое**: 80% (100%)
- **Максимум**: 90% (120%)
- **Источник**: Картотека арбитражных дел

### 3. Минимизация штрафов и санкций - 15%
- **Целевое значение**: снижение на 20% год к году
- **Формула**: Сумма штрафов текущий год / предыдущий год
- **Источник**: Финансовая отчетность

### 4. Качество договорной работы - 10%
- **Целевое значение**: 0 критичных ошибок
- **Метрики**:
  - Отсутствие претензий по договорам
  - Соответствие корпоративным стандартам
  - Актуализация шаблонов
- **Источник**: Аудит договоров
""",

    "SECURITY": """---
department: Security (Generic Template)
description: Generic KPI template for security departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов безопасности

## Корпоративные КПЭ (40%)

### Стратегические инициативы (20%)
- Обеспечение безопасности активов компании
- Минимизация рисков и угроз

### Операционная эффективность (20%)
- Предотвращение инцидентов безопасности

## Личные КПЭ департамента (60%)

### 1. Отсутствие критичных инцидентов - 20%
- **Целевое значение**: 0 критичных инцидентов
- **Метрики**:
  - Отсутствие хищений имущества
  - Отсутствие несанкционированного доступа
  - Предотвращение мошенничества
- **Источник**: Журнал инцидентов

### 2. Проверка контрагентов - 15%
- **Целевое значение**: 100% проверка перед сделкой
- **Формула**: Проверенные контрагенты / Всего новых × 100%
- **Минимум**: 95% (80%)
- **Целевое**: 100% (100%)
- **Источник**: База проверок

### 3. Работа СКУД - 15%
- **Целевое значение**: ≥ 99% доступность
- **Формула**: Время работы / Рабочее время × 100%
- **Минимум**: 97% (80%)
- **Целевое**: 99% (100%)
- **Максимум**: 99.5% (120%)
- **Источник**: Система мониторинга СКУД

### 4. Обучение персонала по безопасности - 10%
- **Целевое значение**: 100% охват
- **Формула**: Обученные / Всего сотрудников × 100%
- **Источник**: Журнал обучения
""",

    "PROCUREMENT": """---
department: Procurement (Generic Template)
description: Generic KPI template for procurement departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов закупок

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом
- Связь: своевременное обеспечение ресурсами

### Операционная эффективность (15%)
- Оптимизация закупочных расходов: экономия 5%

### Стратегические инициативы (10%)
- Развитие базы поставщиков

## Личные КПЭ департамента (60%)

### 1. Своевременность закупок - 20%
- **Целевое значение**: ≥ 95% заявок в срок
- **Формула**: Закупки в SLA / Общее количество × 100%
- **Минимум**: 85% (80%)
- **Целевое**: 95% (100%)
- **Максимум**: 98% (120%)
- **Источник**: Система закупок

### 2. Экономия на закупках - 15%
- **Целевое значение**: ≥ 5% от плановой стоимости
- **Формула**: (План - Факт) / План × 100%
- **Минимум**: 3% (80%)
- **Целевое**: 5% (100%)
- **Максимум**: 7% (120%)
- **Источник**: Финансовые отчеты

### 3. Качество поставщиков - 15%
- **Целевое значение**: ≥ 90% надежных поставщиков
- **Метрики**:
  - Своевременность поставок
  - Качество продукции
  - Соответствие условиям договоров
- **Формула**: Надежные поставщики / Всего активных × 100%
- **Источник**: Реестр поставщиков

### 4. Соблюдение процедур закупок - 10%
- **Целевое значение**: 100% соответствие
- **Метрики**:
  - Соблюдение 44-ФЗ/223-ФЗ
  - Отсутствие нарушений при аудите
  - Корректность документации
- **Источник**: Аудит закупок
""",

    "MARKETING": """---
department: Marketing (Generic Template)
description: Generic KPI template for marketing departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для маркетинговых департаментов

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (20%)
- Целевое значение: определяется годовым планом
- Связь: генерация лидов и продвижение

### Стратегические инициативы (10%)
- Развитие бренда: рост узнаваемости на 10%
- Цифровой маркетинг: рост охвата

### Операционная эффективность (10%)
- ROI маркетинговых кампаний

## Личные КПЭ департамента (60%)

### 1. Генерация лидов - 20%
- **Целевое значение**: определяется планом
- **Формула**: Количество квалифицированных лидов
- **Минимум**: 80% от плана (80%)
- **Целевое**: 100% от плана (100%)
- **Максимум**: 120% от плана (120%)
- **Источник**: CRM, аналитика

### 2. Стоимость привлечения клиента (CAC) - 15%
- **Целевое значение**: снижение на 10% год к году
- **Формула**: Маркетинговые расходы / Количество новых клиентов
- **Источник**: Финансовая отчетность, CRM

### 3. ROI маркетинговых кампаний - 15%
- **Целевое значение**: ≥ 300%
- **Формула**: (Выручка - Затраты) / Затраты × 100%
- **Минимум**: 200% (80%)
- **Целевое**: 300% (100%)
- **Максимум**: 400% (120%)
- **Источник**: Аналитика кампаний

### 4. Узнаваемость бренда - 10%
- **Целевое значение**: рост на 10% год к году
- **Формула**: % осведомленности в целевой аудитории
- **Источник**: Маркетинговые исследования
""",

    "QUALITY": """---
department: Quality (Generic Template)
description: Generic KPI template for quality control departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов контроля качества

## Корпоративные КПЭ (40%)

### Ввод в эксплуатацию ЖК (15%)
- Целевое значение: определяется годовым планом
- Связь: обеспечение качества объектов

### Стратегические инициативы (15%)
- Внедрение системы менеджмента качества
- Соответствие ISO 9001

### Удовлетворенность клиентов (10%)
- NPS ≥ 40

## Личные КПЭ департамента (60%)

### 1. Процент выявленных дефектов до сдачи - 20%
- **Целевое значение**: ≥ 95%
- **Формула**: Дефекты найденные ОТК / Все дефекты × 100%
- **Минимум**: 85% (80%)
- **Целевое**: 95% (100%)
- **Максимум**: 98% (120%)
- **Источник**: Журналы ОТК

### 2. Снижение рекламаций - 15%
- **Целевое значение**: ≤ 2% от объема работ
- **Формула**: Рекламации / Объем работ × 100%
- **Минимум**: ≤ 5% (80%)
- **Целевое**: ≤ 2% (100%)
- **Максимум**: ≤ 1% (120%)
- **Источник**: База рекламаций

### 3. Соответствие стандартам качества - 15%
- **Целевое значение**: 100% соответствие
- **Метрики**:
  - Соблюдение СНиП/ГОСТ
  - Прохождение сертификационных аудитов
  - Отсутствие критичных несоответствий
- **Источник**: Аудиты, протоколы

### 4. Своевременность проверок - 10%
- **Целевое значение**: 100% проверок в графике
- **Формула**: Проверки в срок / Запланированные × 100%
- **Источник**: График контроля
""",

    "DEVELOPMENT": """---
department: Development (Generic Template)
description: Generic KPI template for business development departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов развития

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом
- Связь: развитие новых направлений бизнеса

### Стратегические инициативы (15%)
- Запуск новых проектов: плановое количество
- Масштабирование бизнеса

### Инвестиции (10%)
- ROI инвестиционных проектов ≥ 15%

## Личные КПЭ департамента (60%)

### 1. Запуск новых проектов - 20%
- **Целевое значение**: согласно плану
- **Формула**: Запущенные проекты / Плановые × 100%
- **Минимум**: 80% (80%)
- **Целевое**: 100% (100%)
- **Максимум**: 120% (120%)
- **Источник**: Портфель проектов

### 2. Выход на окупаемость - 15%
- **Целевое значение**: согласно бизнес-плану
- **Метрики**:
  - Достижение целевых показателей выручки
  - Соблюдение сроков окупаемости
  - ROI ≥ целевого
- **Источник**: Финансовые модели

### 3. Привлечение инвестиций - 15%
- **Целевое значение**: согласно плану
- **Формула**: Привлеченные средства / Плановые × 100%
- **Источник**: Инвестиционные соглашения

### 4. Анализ рынка и конкурентов - 10%
- **Целевое значение**: 4 отчета в квартал
- **Метрики**:
  - Регулярность исследований
  - Качество аналитики
  - Практическая применимость выводов
- **Источник**: Аналитические отчеты
""",

    "STRATEGY": """---
department: Strategy (Generic Template)
description: Generic KPI template for strategy departments
format_version: '1.0'
source: Auto-generated template
---

# KPI для департаментов стратегии

## Корпоративные КПЭ (40%)

### Стратегические инициативы (20%)
- Выполнение стратегического плана: ≥ 90%
- Достижение целевых показателей

### Продажи/Выручка компании (10%)
- Целевое значение: определяется годовым планом

### Операционная эффективность (10%)
- Вклад в общую эффективность компании

## Личные КПЭ департамента (60%)

### 1. Выполнение стратегического плана - 25%
- **Целевое значение**: ≥ 90% инициатив
- **Формула**: Выполненные инициативы / Плановые × 100%
- **Минимум**: 80% (80%)
- **Целевое**: 90% (100%)
- **Максимум**: 95% (120%)
- **Источник**: Отчеты по стратегии

### 2. Качество стратегической аналитики - 15%
- **Целевое значение**: своевременность и точность
- **Метрики**:
  - Регулярность отчетов
  - Практическая применимость
  - Обоснованность рекомендаций
- **Источник**: Оценка руководства

### 3. Координация межфункциональных проектов - 10%
- **Целевое значение**: ≥ 85% проектов в срок
- **Формула**: Проекты в срок / Всего проектов × 100%
- **Источник**: MS Project, отчеты

### 4. Мониторинг KPI компании - 10%
- **Целевое значение**: актуальность dashboard
- **Метрики**:
  - Еженедельное обновление
  - Полнота данных ≥ 95%
  - Качество визуализации
- **Источник**: BI система
""",

    "GENERIC": """---
department: Generic (Universal Template)
description: Universal KPI template for departments without specific template
format_version: '1.0'
source: Auto-generated template
---

# Базовые KPI для департамента

## Корпоративные КПЭ (40%)

### Продажи/Выручка компании (15%)
- Целевое значение: определяется годовым планом компании
- Единицы: млн. руб.
- Тип: На увеличение, чем больше, тем лучше
- Источник: Финансовая отчетность

### Ввод в эксплуатацию ЖК (15%)
- Целевое значение: определяется годовым планом
- Единицы: тыс. м²
- Тип: На увеличение, чем больше, тем лучше
- Источник: Отчеты по строительству

### Стратегические инициативы компании (10%)
- Целевое значение: выполнение плановых показателей
- Вклад департамента в общекорпоративные цели

## Личные КПЭ департамента (60%)

### 1. Выполнение ключевых задач департамента - 20%
- **Целевое значение**: ≥ 90% задач выполнено в срок
- **Формула**: Задачи выполненные в срок / Общее количество задач × 100%
- **Минимум**: 80% выполнения (80% от KPI)
- **Целевое**: 90% выполнения (100% от KPI)
- **Максимум**: 95% выполнения (120% от KPI)
- **Источник**: Трекер задач (Jira, MS Project), отчеты руководителя

### 2. Качество выполненных работ - 20%
- **Целевое значение**: ≥ 85% работ без переделок
- **Формула**: Задачи принятые с первого раза / Общее количество × 100%
- **Минимум**: 75% (80%)
- **Целевое**: 85% (100%)
- **Максимум**: 90% (120%)
- **Источник**: Обратная связь от заказчиков работ, аудит

### 3. Эффективность процессов - 10%
- **Целевое значение**: оптимизация времени на 10%
- **Метрики**:
  - Сокращение времени на рутинные операции
  - Автоматизация процессов
  - Повышение производительности труда
- **Формула**: (Время до оптимизации - Время после) / Время до × 100%
- **Источник**: Хронометраж процессов, отчеты

### 4. Соблюдение бюджета департамента - 5%
- **Целевое значение**: отклонение ≤ 5%
- **Формула**: |Факт - План| / План × 100%
- **Минимум**: ≤ 10% (80%)
- **Целевое**: ≤ 5% (100%)
- **Максимум**: ≤ 3% (120%)
- **Источник**: Финансовые отчеты, 1С

### 5. Оценка руководителя - 5%
- **Целевое значение**: ≥ 4/5
- **Метрики**:
  - Качество работы
  - Инициативность
  - Выполнение индивидуальных целей
- **Минимум**: 3.5/5 (80%)
- **Целевое**: 4.0/5 (100%)
- **Максимум**: 4.5/5 (120%)
- **Источник**: Ежеквартальные оценки 1-на-1

## Дополнительные показатели (опционально)

### Инициативность и предложения по улучшению
- Количество внедренных предложений по улучшению процессов
- Участие в кросс-функциональных проектах
- Менторство и обучение коллег

### Командная работа
- Обратная связь от коллег из других департаментов
- Вклад в корпоративную культуру
- Участие в общекорпоративных мероприятиях

---

**Примечание**: Данные KPI являются базовыми и должны быть адаптированы под специфику конкретного департамента. Рекомендуется согласование с руководством для определения релевантных метрик и целевых значений.
"""
}


def detect_department_type(department_name: str) -> str:
    """
    Detect department type from department name.

    Args:
        department_name: Full department name (e.g., "Департамент информационных технологий")

    Returns:
        Department type code (e.g., "IT", "SALES", "GENERIC")

    Examples:
        >>> detect_department_type("Департамент информационных технологий")
        'IT'

        >>> detect_department_type("Отдел продаж B2C")
        'SALES'

        >>> detect_department_type("Управление строительства")
        'CONSTRUCTION'

        >>> detect_department_type("Неизвестный департамент")
        'GENERIC'
    """
    if not department_name:
        return "GENERIC"

    dept_lower = department_name.lower().strip()

    # Check each keyword mapping
    for keyword, dept_type in DEPARTMENT_TYPE_MAPPING.items():
        if keyword == "default":
            continue
        if keyword in dept_lower:
            return dept_type

    # Default fallback
    return "GENERIC"


def get_kpi_template(department_name: str) -> str:
    """
    Get KPI template content for a department.

    Args:
        department_name: Full department name

    Returns:
        KPI template content (markdown string)

    Examples:
        >>> template = get_kpi_template("ДИТ")
        >>> "IT" in template
        True
    """
    dept_type = detect_department_type(department_name)
    return KPI_TEMPLATES.get(dept_type, KPI_TEMPLATES["GENERIC"])


def get_available_department_types() -> list:
    """
    Get list of all available department types.

    Returns:
        List of department type codes
    """
    return list(set(DEPARTMENT_TYPE_MAPPING.values()))


def get_template_stats() -> dict:
    """
    Get statistics about KPI templates.

    Returns:
        Dict with template statistics
    """
    return {
        "total_templates": len(KPI_TEMPLATES),
        "department_types": get_available_department_types(),
        "keyword_mappings": len(DEPARTMENT_TYPE_MAPPING),
        "templates_list": list(KPI_TEMPLATES.keys())
    }


# For backwards compatibility
def load_kpi_template(dept_type: str) -> str:
    """Load KPI template by department type code"""
    return KPI_TEMPLATES.get(dept_type, KPI_TEMPLATES["GENERIC"])


if __name__ == "__main__":
    # Test the module
    print("=== KPI Templates Module ===")

    stats = get_template_stats()
    print(f"\nTemplate Statistics:")
    print(f"  Total templates: {stats['total_templates']}")
    print(f"  Department types: {len(stats['department_types'])}")
    print(f"  Keyword mappings: {stats['keyword_mappings']}")

    print(f"\nAvailable department types:")
    for dept_type in sorted(stats['department_types']):
        print(f"  - {dept_type}")

    # Test detection
    test_departments = [
        "Департамент информационных технологий",
        "Отдел продаж",
        "Управление строительства",
        "Департамент персонала",
        "Какой-то неизвестный отдел"
    ]

    print(f"\n=== Testing Department Type Detection ===")
    for dept in test_departments:
        dept_type = detect_department_type(dept)
        print(f"{dept:50s} -> {dept_type}")
